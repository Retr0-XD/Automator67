name: 'Automator67 CI/CD Pipeline'

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # DETECTION: Determine which parts of the project changed
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if git diff ${{ github.event.before }} ${{ github.event.after }} --name-only | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff ${{ github.event.before }} ${{ github.event.after }} --name-only | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff ${{ github.event.before }} ${{ github.event.after }} --name-only | grep -q "^docs/"; then
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "docs=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # FRONTEND: All frontend tests and quality checks
  # ============================================================================
  frontend-tests:
    name: Frontend - All Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Run linting
        id: lint
        run: npm run lint
        working-directory: frontend
        continue-on-error: true

      - name: Check code formatting
        id: format
        run: npm run format:check
        working-directory: frontend
        continue-on-error: true

      - name: Type checking
        id: typecheck
        run: npx tsc -b
        working-directory: frontend
        continue-on-error: true

      - name: Run unit tests
        id: tests
        run: npm run test:run
        working-directory: frontend
        continue-on-error: true

      - name: Build application
        id: build
        run: npm run build
        working-directory: frontend
        continue-on-error: true

      - name: CSS validation
        id: css
        run: |
          echo "Checking for incompatible @apply directives..."
          if grep -r "@apply.*-" frontend/src --include="*.css" --include="*.tsx" --include="*.ts" 2>/dev/null | grep -v "node_modules" | grep -E "@apply\s+(border-|bg-|text-|ring-)" || true; then
            if [ $? -ne 0 ]; then
              echo "✅ CSS validation passed"
            else
              echo "⚠️ Found potentially incompatible styles"
            fi
          fi
        working-directory: .
        continue-on-error: true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: frontend/coverage
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload build artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

      - name: Create test summary
        if: always()
        run: |
          echo "## Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ steps.lint.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting | ${{ steps.format.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Checking | ${{ steps.typecheck.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS Validation | ${{ steps.css.outcome }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical tests failed
        if: |
          steps.typecheck.outcome == 'failure' ||
          steps.tests.outcome == 'failure' ||
          steps.build.outcome == 'failure'
        run: exit 1

  # ============================================================================
  # BACKEND: Backend tests (placeholder for future)
  # ============================================================================
  backend-tests:
    name: Backend - All Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: Backend tests - Not yet implemented
        run: echo "Backend tests will be added in Milestone 1.2"

  # ============================================================================
  # DOCUMENTATION: Validate documentation
  # ============================================================================
  docs-validate:
    name: Docs - Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown formatting
        run: |
          echo "Validating markdown files..."
          find docs -name "*.md" -type f | while read file; do
            if [ -f "$file" ]; then
              echo "✅ Found: $file"
            fi
          done

  # ============================================================================
  # FINAL STATUS: Report overall pipeline status
  # ============================================================================
  pipeline-status:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    if: always()
    steps:
      - name: Report Status
        run: |
          echo "## Automator67 CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Tests**: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.frontend-tests.result }}" = "success" ]; then
            echo "✅ **Pipeline PASSED - All checks completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Pipeline FAILED - Please review the logs above**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if pipeline failed
        if: needs.frontend-tests.result == 'failure'
        run: exit 1
